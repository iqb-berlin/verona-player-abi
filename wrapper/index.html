<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Verona Player Abi 2.0.0</title>

  <meta name="application-name" content="verona-player-abi"
        data-version="2.0.0"
        data-repository-url="https://github.com/iqb-berlin/verona-player-abi"
        data-api-version="2.1.0"
        data-not-supported-api-features=""
        data-supported-unit-definition-types="iqb-scripted@1.0"
        data-supported-unit-state-data-types="iqb-key-value@1.0.0"
        data-supported-browsers='{"Firefox": 69, "Chrome": 72, "Edge": 79}'
  />
  <link rel="stylesheet" href="verona-player-abi.css">
</head>
<body>
  <script type="text/javascript" src="verona-player-abi.js"></script>
  <script>
    const isProductionMode = false;
    let sessionId;
    let playerMetadata = document.querySelectorAll("meta")[1].attributes;
    let tempResponses = '{}'; // TODO refactor to actual object
    let storedResponses = '{}';
    let myScript = `iqb-scripted::1.0
title::Testscript Title
header::Abschnitt 1 Basic Elements
header
text::Standard Text Element
html::HTML Ele with <strong>strong</strong> text and hyperlink: <a href=”https://www.iqb.hu-berlin.de”>IQB website</a>
hr
rem::Kommentar. Soll nicht erscheinen!
header::Abschnitt 2 Eingabeelemente
input-text::text_var1::1::Text eingeben::Text nach Feld::0::10
input-number::num_var1::1::Nummer eingeben::Text nach Feld::0::10
header::Abschnitt 3 Auswahlelemente
checkbox::check_var1::0::Bitte ankreuzen
if-start::check_var1::true
  text::Checked
if-end
multiple-choice::mc_var1::1::Multiple Choice Feld: ::Choice1##Choice2##Choice3
if-start::mc_var1::1
  text::Choice 1 chosen
  if-start::check_var1::true
    text::and Checked
  if-end
if-else
  text::NOT Choice1
if-end
repeat-start::examineecount::Wie viele Prüflinge gibt es?::Angaben zu Prüfling::20
  text::Repeat Inhalt
  if-start::check_var1::true
    text::Checked
  if-end
repeat-end
repeat-start::examineecount::Wie viele Prüflinge gibt es?::Angaben zu Prüfling::20
  text::Repeat Inhalt
  repeat-start::examineecount::Wie viele Prüflinge gibt es2?::Angaben zu Prüfling::20
    text::Repeat Inhalt2
  repeat-end
repeat-end`;
    let playerStartData = {
      unitDefinition: myScript,
      unitState: {
        dataParts: { allResponses: {} }
      }
    };

    function elementValueChanged(event) {
      if (isProductionMode) {
        window.parent.postMessage({
          type: 'vopStateChangedNotification',
          sessionId: sessionId,
          timeStamp: Date.now(),
          unitState: {
            dataParts: {
              allResponses: event.detail
            },
            unitStateType: playerMetadata.getNamedItem('supported-unit-state-data-types').value,
          }
        }, '*');
      } else {
        tempResponses = event.detail;
        console.log('player sends data', event.detail);
      }
    }

    if (isProductionMode) {
      window.addEventListener('message', (event) => {
        if ('data' in event && 'type' in event.data) {
          switch (event.data.type) {
            case 'vopStartCommand':
              if (event.data.sessionId) {
                sessionId = event.data.sessionId;
                playerStartData = event.data;
              } else {
                console.error('player: (vopStartCommand) no sessionId is given');
              }
              break;
            case 'vopPageNavigationCommand':
            case 'vopGetStateRequest':
            case 'vopStopCommand':
            case 'vopContinueCommand':
              console.warn(`player: message of type ${event.data.type} not processed yet`);
              break;
            default:
              console.warn(`player: got message of unknown type ${event.data.type}`);
          }
        }
      });
      window.addEventListener('blur', () => {
        window.parent.postMessage({
          type: 'vopWindowFocusChangedNotification',
          sessionId: sessionId,
          hasFocus: document.hasFocus()
        }, '*');
      });
      window.addEventListener('focus', () => {
        window.parent.postMessage({
          type: 'vopWindowFocusChangedNotification',
          sessionId: sessionId,
          hasFocus: document.hasFocus()
        }, '*');
      });
      window.parent.postMessage({
        type: 'vopReadyNotification',
        apiVersion: playerMetadata.getNamedItem('data-api-version').value,
        notSupportedApiFeatures: playerMetadata.getNamedItem('not-supported-api-features').value,
        supportedUnitDefinitionTypes: playerMetadata.getNamedItem('supported-unit-definition-types').value,
        supportedUnitStateDataTypes: playerMetadata.getNamedItem('supported-unit-state-data-types').value,
      }, '*');
    } else {
      playerStartData = {
        unitDefinition: myScript,
        unitState: {
          dataParts: { allResponses: storedResponses }
        }
      };
    }

    const playerComponent = document.createElement('player-component',{ is : 'player-component' });
    playerComponent.addEventListener('valueChanged', (event) => {
      elementValueChanged(event);
    });
    document.body.appendChild(playerComponent);
    playerComponent.startData = playerStartData;
    console.log('playerComponent1', playerComponent);

    if (!isProductionMode) {
      const buttonGroupDiv = document.createElement('div');
      const loadScriptButton = document.createElement('button');
      loadScriptButton.textContent = 'Skript laden';
      loadScriptButton.title = 'Script eingeben';
      loadScriptButton.onclick = function() {
        const loadScriptButtonGroupDiv = document.createElement('div');

        const scriptInputTextArea = document.createElement('textarea');
        scriptInputTextArea.setAttribute('rows', '14');
        scriptInputTextArea.setAttribute('cols', '99');

        const confirmLoadButton = document.createElement('button');
        confirmLoadButton.textContent = 'Okay';
        confirmLoadButton.onclick = function() {
          if (scriptInputTextArea.value) {
            playerStartData = {
              unitDefinition: scriptInputTextArea.value,
              unitState: {
                dataParts: { allResponses: '{}' }
              }
            };
            playerComponent.startData = playerStartData;
            closeLoadScriptDiv();
          }
        }

        const cancelLoadButton = document.createElement('button');
        cancelLoadButton.textContent = 'Abruch';
        cancelLoadButton.onclick = function() {
          closeLoadScriptDiv();
        }

        document.body.appendChild(scriptInputTextArea);
        loadScriptButtonGroupDiv.appendChild(confirmLoadButton);
        loadScriptButtonGroupDiv.appendChild(cancelLoadButton);
        document.body.appendChild(loadScriptButtonGroupDiv);

        function closeLoadScriptDiv() {
          document.body.removeChild(scriptInputTextArea);
          document.body.removeChild(loadScriptButtonGroupDiv);
        }
      }
      buttonGroupDiv.appendChild(loadScriptButton);

      const saveScriptButton = document.createElement('button');
      saveScriptButton.textContent = 'Speichern';
      saveScriptButton.title = 'Speichere die aktuellen Antworten';
      buttonGroupDiv.appendChild(saveScriptButton);

      const restoreResponsesButton = document.createElement('button');
      restoreResponsesButton.textContent = 'Wiederherstellen';
      restoreResponsesButton.title = 'Stelle alle gespeicherten Antworten wieder her';
      buttonGroupDiv.appendChild(restoreResponsesButton);
      document.body.appendChild(buttonGroupDiv);
    }

  </script>
</body>
</html>
